<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>clawser ‚Äî browser agent workspace</title>
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#58a6ff">
  <link rel="stylesheet" href="./clawser.css">
</head>
<body>

<div id="viewHome">
  <header>
    <span class="logo">clawser</span>
    <span class="spacer"></span>
  </header>
  <div class="home-content">
    <div class="home-inner">
      <!-- Workspaces -->
      <section class="home-section">
        <h2>Workspaces</h2>
        <div class="home-create-row">
          <input type="text" id="homeWsNewName" placeholder="New workspace..."
            class="home-ws-input" />
          <button id="homeWsCreate" class="btn-sm home-ws-create-btn">+ Create</button>
        </div>
        <div id="homeWsList"></div>
      </section>

      <!-- Global Accounts -->
      <section class="home-section">
        <h2>Accounts</h2>
        <div id="homeAcctList"></div>
        <button id="homeAcctAddToggle" class="btn-sm home-acct-toggle">+ Add Account</button>
        <div id="homeAcctAddForm" class="home-acct-form">
          <div class="config-group">
            <label>Service</label>
            <select id="homeAcctService">
              <option value="anthropic">Anthropic</option>
              <option value="openai">OpenAI</option>
              <option value="groq">Groq</option>
              <option value="openrouter">OpenRouter</option>
              <option value="together">Together AI</option>
              <option value="fireworks">Fireworks AI</option>
              <option value="mistral">Mistral AI</option>
              <option value="deepseek">DeepSeek</option>
              <option value="xai">xAI (Grok)</option>
              <option value="perplexity">Perplexity</option>
              <option value="ollama">Ollama (local)</option>
              <option value="lmstudio">LM Studio (local)</option>
            </select>
          </div>
          <div class="config-group">
            <label>Name</label>
            <input type="text" id="homeAcctName" placeholder="e.g. My Anthropic" />
          </div>
          <div class="config-group">
            <label>API Key</label>
            <input type="password" id="homeAcctKey" placeholder="sk-..." />
          </div>
          <div class="config-group">
            <label>Model</label>
            <input type="text" id="homeAcctModel" list="homeModelSuggestions" />
            <datalist id="homeModelSuggestions"></datalist>
          </div>
          <div class="btn-row">
            <button class="btn-sm" id="homeAcctSave">Save</button>
            <button class="btn-sm btn-surface2" id="homeAcctCancel">Cancel</button>
          </div>
        </div>
      </section>
    </div>
  </div>
</div>

<div id="viewWorkspace">
<header>
  <span class="logo">clawser</span>
  <span class="sep">/</span>
  <span class="mode ws-name-wrap" id="workspaceName" title="Click to switch workspace">workspace</span>
  <span class="sep" id="providerSep">¬∑</span>
  <span class="mode provider-label" id="providerLabel"></span>
  <span class="spacer"></span>
  <span id="costDisplay" class="cost-display" title="Session cost estimate"></span>
  <span id="autonomyBadge" class="autonomy-badge" title="Autonomy level"></span>
  <span id="daemonBadge" class="daemon-badge" title="Daemon status"></span>
  <span id="remoteBadge" class="remote-badge" title="Remote sessions"></span>
  <div class="status">
    <span class="dot" id="statusDot"></span>
    <span id="statusText">loading...</span>
  </div>
</header>

<!-- Workspace dropdown (hidden by default) -->
<div id="wsDropdown" class="ws-dropdown">
  <div id="wsList"></div>
  <div class="ws-dd-create-row">
    <input type="text" id="wsNewName" placeholder="New workspace..." class="ws-dd-input" />
    <button id="wsCreate" class="ws-dd-create-btn">+</button>
  </div>
</div>

<div class="workspace">
  <!-- Sidebar navigation -->
  <nav class="sidebar">
    <button class="active" data-panel="chat" title="Chat">üí¨</button>
    <button data-panel="tools" title="Tool Calls">üîß</button>
    <button data-panel="files" title="Files (OPFS)">üìÅ</button>
    <span class="sep-line"></span>
    <button data-panel="memory" title="Memory">üß†</button>
    <button data-panel="goals" title="Goals">üéØ</button>
    <button data-panel="events" title="Events">üì°</button>
    <button data-panel="skills" title="Skills">üß©</button>
    <button data-panel="terminal" title="Terminal">üñ•</button>
    <button data-panel="dashboard" title="Dashboard">üìä</button>
    <span class="sep-line"></span>
    <button data-panel="config" title="Settings">‚öôÔ∏è</button>
  </nav>

  <div class="panels">
    <!-- Chat -->
    <div class="panel active-panel" id="panelChat">
      <div class="panel-header panel-header-flush">
        <div class="conv-bar conv-bar-wrap">
          <span class="conv-label">Conversation</span>
          <span class="conv-name" id="convName" title="New conversation">New conversation</span>
          <span class="spacer"></span>
          <button class="btn-new" id="convNew" title="New conversation">+ New</button>
          <button class="btn-save" id="convRename" title="Rename conversation">Rename</button>
          <button class="btn-hist" id="convHist" title="Conversation history">History</button>
          <!-- Conversation history dropdown -->
          <div class="conv-dropdown" id="convDropdown"></div>
        </div>
      </div>
      <div class="panel-body messages" id="messages">
        <div class="msg system">Initializing agent...</div>
      </div>
      <div class="input-row input-row-wrap">
        <div class="slash-autocomplete" id="slashAutocomplete"></div>
        <input type="text" id="userInput" placeholder="Message the agent..." disabled />
        <button id="cmdPaletteBtn" class="cmd-palette-btn-style" title="Command Palette (‚åòK)" disabled>‚ö°</button>
        <button id="sendBtn" disabled>Send</button>
      </div>
    </div>

    <!-- Tool Calls -->
    <div class="panel" id="panelTools">
      <div class="panel-header">Tool Calls <span class="badge" id="toolCount">0</span></div>
      <div class="panel-body" id="toolCalls"></div>
    </div>

    <!-- Files (OPFS) -->
    <div class="panel" id="panelFiles">
      <div class="panel-header">Files (OPFS) <button class="btn-sm ml-auto" id="refreshFiles">Refresh</button></div>
      <div class="panel-body panel-mono" id="fileList"></div>
    </div>

    <!-- Memory -->
    <div class="panel" id="panelMemory">
      <div class="panel-header">Memory <span class="badge" id="memCount">0</span><span class="spacer"></span><button class="btn-sm ml-auto" id="memAddToggle">+ Add</button></div>
      <!-- Add memory form (hidden by default) -->
      <div class="mem-form mem-add-form" id="memAddForm">
        <input type="text" id="memNewKey" placeholder="Key (e.g. user_preference)" />
        <textarea id="memNewContent" placeholder="Content..."></textarea>
        <div class="mem-form-row">
          <select id="memNewCat"><option value="core">core</option><option value="learned">learned</option><option value="user">user</option><option value="context">context</option></select>
          <button class="btn-sm" id="memNewSave">Save</button>
          <button class="btn-sm btn-surface2" id="memNewCancel">Cancel</button>
        </div>
      </div>
      <div class="config-group mem-filter-row">
        <div class="flex-1">
          <input type="text" id="memQuery" placeholder="Search memories..." />
        </div>
        <select id="memCatFilter" class="mem-cat-filter">
          <option value="">all categories</option>
          <option value="core">core</option>
          <option value="learned">learned</option>
          <option value="user">user</option>
          <option value="context">context</option>
        </select>
        <button class="btn-sm" id="memSearch">Search</button>
        <button class="btn-sm btn-surface2" id="memListAll">All</button>
      </div>
      <div class="panel-body panel-mono" id="memResults"></div>
    </div>

    <!-- Goals -->
    <div class="panel" id="panelGoals">
      <div class="panel-header">Goals <span class="badge" id="goalCount">0</span></div>
      <div class="config-group">
        <input type="text" id="goalInput" placeholder="Add a goal..." />
        <button class="btn-sm" id="goalAdd">Add</button>
      </div>
      <div class="panel-body panel-mono" id="goalList"></div>
    </div>

    <!-- Events -->
    <div class="panel" id="panelEvents">
      <div class="panel-header">Event Stream <span class="badge" id="eventCount">0</span></div>
      <div class="panel-body" id="eventLog"></div>
    </div>

    <!-- Skills -->
    <div class="panel" id="panelSkills">
      <div class="panel-header">
        Skills <span class="badge" id="skillCount">0</span>
        <span class="spacer"></span>
        <button class="btn-sm" id="skillRefresh">Refresh</button>
        <label class="btn-sm skill-import-label">
          Import <input type="file" id="skillImportFile" accept=".zip" style="display:none;" />
        </label>
      </div>
      <div id="skillScopeSelect" class="skill-scope-bar">
        <label class="skill-scope-label">Install scope:</label>
        <div class="skill-scope-btns">
          <button class="btn-sm skill-scope-btn flex-1" data-scope="global">Global</button>
          <button class="btn-sm skill-scope-btn btn-surface2 flex-1" data-scope="workspace">Workspace</button>
          <button class="btn-sm skill-scope-cancel" id="skillScopeCancel">Cancel</button>
        </div>
      </div>
      <div class="panel-body panel-mono" id="skillList"></div>
    </div>

    <!-- Terminal (Block 1) -->
    <div class="panel" id="panelTerminal">
      <div class="panel-header">Terminal</div>
      <div class="panel-body panel-mono terminal-output" id="terminalOutput"></div>
      <div class="terminal-input-row">
        <span class="terminal-cwd" id="terminalCwd">~</span>
        <input type="text" id="terminalInput" class="terminal-input" placeholder="$ command..." />
      </div>
    </div>

    <!-- Dashboard (Block 10) -->
    <div class="panel" id="panelDashboard">
      <div class="panel-header">Dashboard <button class="btn-sm ml-auto" id="dashRefresh">Refresh</button></div>
      <div class="panel-body">
        <div class="dash-grid" id="dashMetrics">
          <div class="dash-card"><div class="val" id="dashRequests">0</div><div class="lbl">Requests</div></div>
          <div class="dash-card"><div class="val" id="dashTokens">0</div><div class="lbl">Tokens</div></div>
          <div class="dash-card"><div class="val" id="dashErrors">0</div><div class="lbl">Errors</div></div>
          <div class="dash-card"><div class="val" id="dashLatency">0ms</div><div class="lbl">Avg Latency</div></div>
        </div>
        <div class="config-group"><label>Recent Logs</label></div>
        <div class="panel-body panel-mono dash-log-wrap" id="dashLogViewer"></div>
      </div>
    </div>

    <!-- Config -->
    <div class="panel" id="panelConfig">
      <div class="panel-header">Configuration</div>
      <div class="panel-body panel-body-flush">
        <div class="config-group">
          <label>Provider</label>
          <select id="providerSelect"></select>
        </div>
        <div class="config-group">
          <label>Accounts <button class="btn-sm acct-toggle" id="acctAddToggle">+ Add</button></label>
        </div>
        <!-- Account add form -->
        <div id="acctAddForm" class="acct-form">
          <div class="config-group">
            <label>Service</label>
            <select id="acctService">
              <option value="anthropic">Anthropic</option>
              <option value="openai">OpenAI</option>
              <option value="groq">Groq</option>
              <option value="openrouter">OpenRouter</option>
              <option value="together">Together AI</option>
              <option value="fireworks">Fireworks AI</option>
              <option value="mistral">Mistral AI</option>
              <option value="deepseek">DeepSeek</option>
              <option value="xai">xAI (Grok)</option>
              <option value="perplexity">Perplexity</option>
              <option value="ollama">Ollama (local)</option>
              <option value="lmstudio">LM Studio (local)</option>
            </select>
          </div>
          <div class="config-group">
            <label>Name</label>
            <input type="text" id="acctName" placeholder="e.g. My Anthropic" />
          </div>
          <div class="config-group">
            <label>API Key</label>
            <input type="password" id="acctKey" placeholder="sk-..." />
          </div>
          <div class="config-group">
            <label>Model</label>
            <input type="text" id="acctModel" list="modelSuggestions" />
            <datalist id="modelSuggestions"></datalist>
          </div>
          <div class="btn-row">
            <button class="btn-sm" id="acctSave">Save</button>
            <button class="btn-sm btn-surface2" id="acctCancel">Cancel</button>
          </div>
        </div>
        <!-- Account list -->
        <div id="acctList"></div>
        <div class="config-group">
          <label>System Prompt</label>
          <textarea id="systemPrompt">You are clawser, a browser-native AI agent. Respond conversationally to normal messages. Only use tools when the user asks you to perform an action (fetch a page, read a file, interact with the browser, etc.). When you do need tools, write JavaScript in a ```js or ```tool_code block using the available functions.</textarea>
        </div>

        <div class="config-group">
          <label>Registered Tools</label>
        </div>
        <div class="panel-body tool-list tool-registry-scroll" id="toolRegistry"></div>

        <!-- State dashboard -->
        <div class="config-group"><label>Agent State</label></div>
        <div class="state-grid-wrap">
          <div class="state-grid" id="stateGrid">
            <div class="state-card"><div class="val" id="stHistory">-</div><div class="lbl">History</div></div>
            <div class="state-card"><div class="val" id="stMemory">-</div><div class="lbl">Memory</div></div>
            <div class="state-card"><div class="val" id="stGoals">-</div><div class="lbl">Goals</div></div>
            <div class="state-card"><div class="val" id="stJobs">-</div><div class="lbl">Jobs</div></div>
          </div>
        </div>

        <!-- MCP (advanced, collapsed by default) -->
        <div class="config-group config-toggle" id="mcpToggle">
          <label class="config-toggle">MCP Servers (advanced) <span id="mcpArrow" class="config-arrow">&#x25B6;</span></label>
        </div>
        <div id="mcpSection" class="config-section-hidden">
          <div class="config-group">
            <input type="text" id="mcpEndpoint" placeholder="http://localhost:3000/mcp" />
            <button class="btn-sm" id="mcpConnect">Connect</button>
          </div>
          <div id="mcpServers" class="mcp-servers-wrap"></div>
        </div>

        <!-- Autonomy & Costs (Block 6) -->
        <div class="config-group config-toggle" id="autonomyToggle">
          <label class="config-toggle">Autonomy &amp; Costs <span id="autonomyArrow" class="config-arrow">&#x25B6;</span></label>
        </div>
        <div id="autonomySection" class="config-section-hidden">
          <div class="config-group">
            <label>Autonomy Level</label>
            <div class="radio-group" id="autonomyLevel">
              <label class="radio-label"><input type="radio" name="autonomyLevel" value="readonly" /> Read-Only</label>
              <label class="radio-label"><input type="radio" name="autonomyLevel" value="supervised" checked /> Supervised</label>
              <label class="radio-label"><input type="radio" name="autonomyLevel" value="full" /> Full</label>
            </div>
          </div>
          <div class="config-group">
            <label>Max Actions / Hour</label>
            <input type="number" id="cfgMaxActions" class="cfg-narrow" min="1" max="1000" value="100" />
          </div>
          <div class="config-group">
            <label>Daily Cost Limit ($)</label>
            <input type="number" id="cfgDailyCostLimit" class="cfg-narrow" min="0" step="0.5" value="5" />
          </div>
          <div class="config-group">
            <label>Cost Today</label>
            <div class="cost-meter-wrap">
              <div class="cost-meter-bar" id="costMeterBar"></div>
              <span class="cost-meter-label" id="costMeterLabel">$0.00 / $5.00</span>
            </div>
          </div>
        </div>

        <!-- Agent Identity (Block 7) -->
        <div class="config-group config-toggle" id="identityToggle">
          <label class="config-toggle">Agent Identity <span id="identityArrow" class="config-arrow">&#x25B6;</span></label>
        </div>
        <div id="identitySection" class="config-section-hidden">
          <div class="config-group">
            <label>Format</label>
            <select id="identityFormat">
              <option value="plain">Plain Text</option>
              <option value="aieos">AIEOS Structured</option>
            </select>
          </div>
          <div class="config-group" id="identityPlainWrap">
            <label>Identity Prompt</label>
            <textarea id="identityPlain" rows="4" placeholder="You are clawser..."></textarea>
          </div>
          <div id="identityAieosWrap" class="config-section-hidden">
            <div class="config-group">
              <label>Name</label>
              <input type="text" id="identityName" placeholder="clawser" />
            </div>
            <div class="config-group">
              <label>Role</label>
              <input type="text" id="identityRole" placeholder="browser-native AI agent" />
            </div>
            <div class="config-group">
              <label>Personality</label>
              <textarea id="identityPersonality" rows="2" placeholder="helpful, concise"></textarea>
            </div>
          </div>
          <div class="config-group">
            <button class="btn-sm" id="identityPreview">Preview</button>
          </div>
          <div id="identityPreviewOut" class="config-section-hidden identity-preview"></div>
        </div>

        <!-- Model Routing (Block 11) -->
        <div class="config-group config-toggle" id="routingToggle">
          <label class="config-toggle">Model Routing <span id="routingArrow" class="config-arrow">&#x25B6;</span></label>
        </div>
        <div id="routingSection" class="config-section-hidden">
          <div class="config-group">
            <label>Fallback Chain</label>
            <div id="routingChainList" class="routing-chain-list"></div>
          </div>
          <div class="config-group">
            <label>Provider Health</label>
            <div id="routingHealthBadges" class="routing-health-badges"></div>
          </div>
          <div class="config-group">
            <button class="btn-sm" id="routingTest">Test Chain</button>
          </div>
        </div>

        <!-- Auth Profiles (Block 19) -->
        <div class="config-group config-toggle" id="authProfilesToggle">
          <label class="config-toggle">Auth Profiles <span id="authProfilesArrow" class="config-arrow">&#x25B6;</span></label>
        </div>
        <div id="authProfilesSection" class="config-section-hidden">
          <div class="config-group">
            <label>Profiles</label>
            <div id="authProfileList" class="auth-profile-list"></div>
          </div>
          <div class="config-group">
            <button class="btn-sm" id="authProfileAdd">+ Add Profile</button>
          </div>
        </div>

        <!-- Self-Repair (Block 22) -->
        <div class="config-group config-toggle" id="selfRepairToggle">
          <label class="config-toggle">Self-Repair <span id="selfRepairArrow" class="config-arrow">&#x25B6;</span></label>
        </div>
        <div id="selfRepairSection" class="config-section-hidden">
          <div class="config-group">
            <label>Tool Timeout (ms)</label>
            <input type="range" id="cfgToolTimeout" min="5000" max="120000" step="5000" value="30000" />
            <span id="cfgToolTimeoutVal" class="range-val">30000</span>
          </div>
          <div class="config-group">
            <label>No Progress Turns</label>
            <input type="range" id="cfgNoProgress" min="2" max="20" step="1" value="5" />
            <span id="cfgNoProgressVal" class="range-val">5</span>
          </div>
          <div class="config-group">
            <label>Loop Detection Window</label>
            <input type="range" id="cfgLoopDetection" min="3" max="20" step="1" value="6" />
            <span id="cfgLoopDetectionVal" class="range-val">6</span>
          </div>
          <div class="config-group">
            <label>Max Consecutive Errors</label>
            <input type="range" id="cfgConsecErrors" min="1" max="10" step="1" value="3" />
            <span id="cfgConsecErrorsVal" class="range-val">3</span>
          </div>
          <div class="config-group">
            <label>Cost Runaway Factor</label>
            <input type="range" id="cfgCostRunaway" min="2" max="20" step="1" value="5" />
            <span id="cfgCostRunawayVal" class="range-val">5</span>
          </div>
        </div>

        <!-- Response Cache (Block 26) -->
        <div class="config-group config-toggle" id="cacheToggle">
          <label class="config-toggle">Response Cache <span id="cacheArrow" class="config-arrow">&#x25B6;</span></label>
        </div>
        <div id="cacheSection" class="config-section-hidden">
          <div class="config-group">
            <label>TTL (minutes)</label>
            <input type="number" id="cfgCacheTTL" class="cfg-narrow" min="1" max="1440" value="30" />
          </div>
          <div class="config-group">
            <label>Max Entries</label>
            <input type="number" id="cfgCacheMaxEntries" class="cfg-narrow" min="10" max="5000" value="500" />
          </div>
          <div class="config-group">
            <label>Cache Stats</label>
            <div id="cacheStats" class="cache-stats">Hits: 0 ¬∑ Misses: 0 ¬∑ Tokens Saved: 0</div>
          </div>
          <div class="config-group">
            <button class="btn-sm" id="cacheClear">Clear Cache</button>
          </div>
        </div>

        <!-- Sandbox Config (Block 28) -->
        <div class="config-group config-toggle" id="sandboxToggle">
          <label class="config-toggle">Sandbox Config <span id="sandboxArrow" class="config-arrow">&#x25B6;</span></label>
        </div>
        <div id="sandboxSection" class="config-section-hidden">
          <div class="config-group">
            <label>Default Sandbox Tier</label>
            <select id="cfgSandboxTier">
              <option value="0">Trusted (no sandbox)</option>
              <option value="1" selected>Worker (isolated)</option>
              <option value="2">WASM (fuel-metered)</option>
            </select>
          </div>
          <div class="config-group">
            <label>Capabilities</label>
            <div id="sandboxCapabilities" class="sandbox-caps"></div>
          </div>
          <div class="config-group">
            <label>Fuel Limit (WASM ops)</label>
            <input type="number" id="cfgFuelLimit" class="cfg-narrow" min="1000" max="10000000" value="1000000" />
          </div>
        </div>

        <!-- Heartbeat (Block 29) -->
        <div class="config-group config-toggle" id="heartbeatToggle">
          <label class="config-toggle">Heartbeat <span id="heartbeatArrow" class="config-arrow">&#x25B6;</span></label>
        </div>
        <div id="heartbeatSection" class="config-section-hidden">
          <div class="config-group">
            <label>Checks</label>
            <div id="heartbeatChecks" class="heartbeat-checks"></div>
          </div>
          <div class="config-group">
            <label>Check Interval</label>
            <select id="cfgHeartbeatInterval">
              <option value="60000">1 min</option>
              <option value="300000" selected>5 min</option>
              <option value="900000">15 min</option>
              <option value="3600000">1 hour</option>
            </select>
          </div>
          <div class="config-group">
            <label>Alert Strategy</label>
            <select id="cfgHeartbeatAlert">
              <option value="log" selected>Log Only</option>
              <option value="notify">Notify</option>
              <option value="prompt">Prompt Agent</option>
            </select>
          </div>
        </div>

        <!-- Security settings -->
        <div class="config-group config-toggle" id="securityToggle">
          <label class="config-toggle">Security <span id="securityArrow" class="config-arrow">&#x25B6;</span></label>
        </div>
        <div id="securitySection" class="config-section-hidden">
          <div class="config-group">
            <label>Domain Allowlist <small class="domain-hint">(comma-separated, blank = allow all)</small></label>
            <input type="text" id="cfgDomainAllowlist" placeholder="e.g. example.com, api.github.com" />
          </div>
          <div class="config-group">
            <label>Max File Size (MB)</label>
            <input type="number" id="cfgMaxFileSize" class="cfg-narrow" min="1" max="100" value="10" />
          </div>
          <div class="security-apply-wrap">
            <button class="btn-sm" id="btnApplySecurity">Apply</button>
          </div>
        </div>

        <!-- Persistence -->
        <div class="config-group">
          <label>Data</label>
          <button class="btn-sm btn-danger" id="btnClearData">Clear All Local Data</button>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Command Palette Modal -->
<div id="cmdPalette" class="modal-overlay cmd-overlay">
  <div class="modal-box cmd-box">
    <div class="cmd-search-row">
      <span class="cmd-icon">‚ö°</span>
      <input type="text" id="cmdSearch" class="modal-input cmd-search-input" placeholder="Search tools..." />
    </div>
    <div id="cmdToolList" class="cmd-tool-scroll"></div>
    <div id="cmdParamArea" class="cmd-param-scroll"></div>
    <div class="modal-btns">
      <button class="modal-btn modal-btn-cancel" id="cmdCancel">Cancel</button>
      <button class="modal-btn modal-btn-ok" id="cmdRun" disabled>Run</button>
    </div>
  </div>
</div>
</div><!-- /viewWorkspace -->

<script type="module" src="./clawser-app.js"></script>
</body>
</html>

# wsh Protocol Specification â€” v1
# This file is the single source of truth for all message types.
# Run: node web/packages/wsh/spec/codegen.mjs

protocol:
  name: wsh
  version: "wsh-v1"
  wire_format: cbor
  framing: length_prefixed_be32

enums:
  ChannelKind:
    type: string
    values: [pty, exec, meta, file]
  AuthMethod:
    type: string
    values: [pubkey, password]

messages:
  handshake:
    Hello:
      code: 0x01
      fields:
        version:
          type: string
          required: true
        username:
          type: string
          required: true
        features:
          type: "string[]"
          default: "[]"
        auth_method:
          type: AuthMethod
          required: false

    ServerHello:
      code: 0x02
      fields:
        session_id:
          type: string
          required: true
        features:
          type: "string[]"
          default: "[]"
        fingerprints:
          type: "string[]"
          default: "[]"

    Challenge:
      code: 0x03
      fields:
        nonce:
          type: bytes
          required: true

    AuthMethods:
      code: 0x04
      fields:
        methods:
          type: "AuthMethod[]"
          required: true

    Auth:
      code: 0x05
      fields:
        method:
          type: AuthMethod
          required: true
        signature:
          type: bytes
          required: false
        public_key:
          type: bytes
          required: false
        password:
          type: string
          required: false

    AuthOk:
      code: 0x06
      fields:
        session_id:
          type: string
          required: true
        token:
          type: bytes
          required: true
        ttl:
          type: u64
          required: true

    AuthFail:
      code: 0x07
      fields:
        reason:
          type: string
          required: true

  channel:
    Open:
      code: 0x10
      fields:
        kind:
          type: ChannelKind
          required: true
        command:
          type: string
          required: false
        cols:
          type: u16
          required: false
        rows:
          type: u16
          required: false
        env:
          type: "map<string,string>"
          required: false

    OpenOk:
      code: 0x11
      fields:
        channel_id:
          type: u32
          required: true
        stream_ids:
          type: "u32[]"
          default: "[]"

    OpenFail:
      code: 0x12
      fields:
        reason:
          type: string
          required: true

    Resize:
      code: 0x13
      fields:
        channel_id:
          type: u32
          required: true
        cols:
          type: u16
          required: true
        rows:
          type: u16
          required: true

    Signal:
      code: 0x14
      fields:
        channel_id:
          type: u32
          required: true
        signal:
          type: string
          required: true

    Exit:
      code: 0x15
      fields:
        channel_id:
          type: u32
          required: true
        code:
          type: i32
          required: true

    Close:
      code: 0x16
      fields:
        channel_id:
          type: u32
          required: true

  transport:
    Error:
      code: 0x20
      fields:
        code:
          type: u32
          required: true
        message:
          type: string
          required: true

    Ping:
      code: 0x21
      fields:
        id:
          type: u64
          required: true

    Pong:
      code: 0x22
      fields:
        id:
          type: u64
          required: true

  session:
    Attach:
      code: 0x30
      fields:
        session_id:
          type: string
          required: true
        token:
          type: bytes
          required: true
        mode:
          type: string
          default: '"control"'

    Resume:
      code: 0x31
      fields:
        session_id:
          type: string
          required: true
        token:
          type: bytes
          required: true
        last_seq:
          type: u64
          required: true

    Rename:
      code: 0x32
      fields:
        session_id:
          type: string
          required: true
        name:
          type: string
          required: true

    IdleWarning:
      code: 0x33
      fields:
        expires_in:
          type: u64
          required: true

    Shutdown:
      code: 0x34
      fields:
        reason:
          type: string
          required: true
        retry_after:
          type: u64
          required: false

    Snapshot:
      code: 0x35
      fields:
        label:
          type: string
          required: true

    Presence:
      code: 0x36
      fields:
        attachments:
          type: "AttachmentInfo[]"
          required: true

    ControlChanged:
      code: 0x37
      fields:
        new_controller:
          type: string
          required: true

    Metrics:
      code: 0x38
      fields:
        cpu:
          type: f64
          required: false
        memory:
          type: u64
          required: false
        sessions:
          type: u32
          required: false
        rtt:
          type: u64
          required: false

  mcp:
    McpDiscover:
      code: 0x40
      fields: {}

    McpTools:
      code: 0x41
      fields:
        tools:
          type: "McpToolSpec[]"
          required: true

    McpCall:
      code: 0x42
      fields:
        tool:
          type: string
          required: true
        arguments:
          type: json
          required: true

    McpResult:
      code: 0x43
      fields:
        result:
          type: json
          required: true

  reverse:
    ReverseRegister:
      code: 0x50
      fields:
        username:
          type: string
          required: true
        capabilities:
          type: "string[]"
          default: "[]"
        public_key:
          type: bytes
          required: true

    ReverseList:
      code: 0x51
      fields: {}

    ReversePeers:
      code: 0x52
      fields:
        peers:
          type: "PeerInfo[]"
          required: true

    ReverseConnect:
      code: 0x53
      fields:
        target_fingerprint:
          type: string
          required: true
        username:
          type: string
          required: true

  framing:
    WsData:
      code: 0x60
      fields: {}
      description: "WebSocket multiplexing framing marker, not a CBOR message"

nested_types:
  AttachmentInfo:
    fields:
      session_id:
        type: string
        required: true
      mode:
        type: string
        required: true
      username:
        type: string
        required: false

  PeerInfo:
    fields:
      fingerprint_short:
        type: string
        required: true
      username:
        type: string
        required: true
      capabilities:
        type: "string[]"
        default: "[]"
      last_seen:
        type: u64
        required: false

  McpToolSpec:
    fields:
      name:
        type: string
        required: true
      description:
        type: string
        required: true
      parameters:
        type: json
        default: "{}"

crypto:
  auth_transcript:
    algorithm: SHA-256
    formula: 'SHA-256(PROTOCOL_VERSION || "\0" || session_id || nonce)'
    note: "channelBinding can be appended but defaults to empty"
  fingerprint:
    algorithm: SHA-256
    input: raw_ed25519_public_key_32_bytes
    output: hex_encoded_64_chars
  session_token:
    format: "[8B expiry_be][32B HMAC-SHA256(secret, session_id || expiry)]"
    total_bytes: 40
  key_type: Ed25519
  ssh_wire_format: '[4B len]["ssh-ed25519"][4B len][32B raw_key]'

transport:
  webtransport:
    description: "QUIC streams as channels. 1 bidi = control. Per channel: 1 bidi + optional uni."
  websocket:
    framing: "[1B msg_type][4B stream_id][payload]"
    ws_data_type: 0x60
